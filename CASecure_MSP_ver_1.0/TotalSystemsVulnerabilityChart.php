<?php
require_once './includes/authenticate.php';
?>

<html>
<head>
<title>CASecure >Source Severity Report</title>

<link rel="stylesheet" type="text/css" href="TABLE_FORMAT_1.css">

<script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
<script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<link rel="stylesheet" type="text/css" href="MSSP_CSS.css">
<link rel="stylesheet" type="text/css" href="MSSP_CSS_bp.css">
<link rel="stylesheet" type="text/css" href="css/blueprint/screen.css" media="screen, projection">
<link rel="stylesheet" type="text/css" href="css/blueprint/print.css" media="print">
<link rel="stylesheet" type="text/css" href="css/blueprint/ie.css" media="screen, projection">

<!-- <link href="includes/jquery.modal/jquery.modal.css" type="text/css" rel="stylesheet" /> -->
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<!-- <script src="includes/jquery.modal/jquery.modal.min.js"></script>  -->

<!-- Remember to include jQuery :) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

<!-- jQuery Modal -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />

<!--
<script src="jquery-3.3.1.min.js"></script>
-->
<!--
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
-->
<!--
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="js/jquery.ajax-cross-origin.min.js"></script>
-->
</head>
<body onload="loadReports()">
<div class="container">


	


<!--
<div class="span-15" style="margin-top:-10px;">
			<nav id="primary_nav_wrap">
				<ul>
					<li id="dashboardNav"><a href="Dashboards.php">Dashboard</a></li>
					<li id="patchingNav"><a href="PatchingOverview.html">Patching</a>
						<ul>
							<li><a href="PatchingOverview.html">Overview</a></li>
							<li><a href="Devices.php">Devices</a></li>
						</ul>
					</li>
					<li id="complianceNav"><a href="ComplianceOverview.php">Compliance</a>
						<ul>
							<li class="dir"><a href="ComplianceOverview.php">Overview</a></li>
							<li class="dir"><a href="PCI.html">PCI</a>
								<ul>
									<li><a href="PCI-DSSWin2008.php">PCI-DSS Windows 2008</a></li>
									<li><a href="PCI-DSSWin7.php">PCI-DSS Windows 7</a></li>
								</ul>
							</li>
							<li class="dir"><a href="#">CIS</a></li>
							<li><a href="#">USGCB</a></li>
						</ul>
					</li>
					<li id="inventoryNav"><a href="#">Inventory</a></li>
					<li id="reportingNav"><a href="Reporting.html">Reporting</a></li>
					<li id="infoNav"><a href="#">Information</a>
						<ul>
							<li><a href="Requests.php">Requests</a></li>
							<li><a href="Enhancements.php">Enhancements</a></li>
							<li><a href="Messages.php">Messages</a></li>
						</ul>
					</li>
				</ul>
			</nav>
		<br>
</div>
-->

<div class="prepend-6 span-2 last" style="margin-top:-5px;">

<!-- Modal Box -->


<!-- Link to open the modal -->


</div>
<script>
 $("#fade").modal({
  fadeDuration: 100,
  fadeDelay: 0.50
});
</script>



<script>
	document.getElementById("reportingNav").className = "current-menu-item";	
	     
		 var chartHeight = 250;
	     var chartWidth = 400;
	     var curUser = "<?php echo $_SESSION['bigfixuser']; ?>"; //"APIAdmin";
	     var password = "<?php echo $_SESSION['bigfixpassword']; ?>"; //"AllieCat7";
	     var server = "<?php echo $_SESSION['bigfixserver']; ?>"; //"bigfix.internal.cassevern.com";
// HTTP encode periods so as to not ruin the URL for the AJAX call
	     server = server.replace(/\./g, "%2E");
	
	     var computerGroup = "<?php echo $_GET['cg']; ?>";
	
// AJAX call for the Windows Update Status Report
	     var severeVulnerabilityProxy = "proxies/SevereVulnerabilityReport.php?user=" + curUser + "&pass=" + password + "&serv=" + server + "&cg=" + computerGroup;
	     xmlTableParser(severeVulnerabilityProxy, "#severeVulnerabilityTable");
	
	// Function performs an AJAX call to a designated API proxy and collects the data into an HTML table
	     function xmlTableParser(proxyURL, tableID) {
		    var request = new XMLHttpRequest();
		    request.open("GET", proxyURL, true);
		    request.send();
		    request.onreadystatechange = function() {
		       if ((this.readyState === 4) && (this.status === 200)) {
			      // Convert the XML document to a string
			      xmlString = this.responseText.toString();
			      // Eliminate the Meta-Query from the <Query> tag in the XML results as it can potentially cause issues when reading the XML code
			      var badQuery = xmlString.substring((parseInt(xmlString.search("Resource"))-1), (parseInt(xmlString.search('Result'))-5));
			      xmlString = xmlString.replace(badQuery, '');
			      // Convert string of XML code back into an XML document
			      var parser = new DOMParser();
			      var xmlDoc = parser.parseFromString(xmlString,"text/xml");
			      // Collect the number of rows (<Tuple> tags) and columns (<Answer> tags per <Tuple> tag) of data from the XML document
			      var tupleCount = xmlDoc.getElementsByTagName("Tuple").length;
			      var columnCount = xmlDoc.getElementsByTagName("Answer").length / tupleCount;
			      // Build the HTML Table's contents from the data in the XML document
			      var rowHTML = "";
			      for (var i = 0; i < tupleCount; i++) {
			         rowHTML = '<tr>';
				     for (var j = 0; j < columnCount; j++) {
				        if (j == 0 || j == 4) {}
				        else {
				   	       rowHTML += '<td nowrap>' + xmlDoc.getElementsByTagName("Answer")[((columnCount*i)+j)].childNodes[0].nodeValue + '</td>';
					    }
				     }
				     rowHTML += '</tr>';
				     $(tableID).append(rowHTML);
				     $(document).ready( function () {
				        $('#severeVulnerabilityTable').dataTable();
				     });
			      }
				  
				  
				 var severeVulnerabilityArray = [0,0];
			      var vulnerabilityTable = document.getElementById('severeVulnerabilityTable');
				
			      var vulnerabilityRows = vulnerabilityTable.rows, 
			      vulnerabilityRowCount = vulnerabilityRows.length, 
			      vulnerabilityCells;
				
			      for (var r = 1; r < vulnerabilityRowCount; r++) {
			         vulnerabilityCells = vulnerabilityRows[r].cells;
			         severeVulnerabilityArray[0] += parseInt(vulnerabilityCells[4].innerHTML);
			         severeVulnerabilityArray[1] += parseInt(vulnerabilityCells[5].innerHTML);
			      }
				 //alert(severeVulnerabilityArray);
				
				CanvasJS.addColorSet("statusShades",
			         [//colorSet Array
				        "#006600", 
					    "#FF0000"
				     ]
			      );
			      var chart3 = new CanvasJS.Chart("severeVulnerabilityChart", {
			         colorSet: "statusShades",
				     title:{
				        text: "Total Systems Vulnerablility",
				        //padding: 5
				     },
				     legend: {
				        horizontalAlign: "center",
					    verticalAlign: "bottom",
				     },
				     height: chartHeight,
				     width: chartWidth,
				     backgroundColor: "#ebedf2",
				     data: [              
				        {
					       // Change type to "line", "doughnut", "splineArea", etc. "column"
						   type: "pie",
						   startAngle: 270,
						   indexLabelPlacement: "outside", 
						   showInLegend: true,
						   dataPoints: [
						      { label: "Applied Patches",  y: severeVulnerabilityArray[0], name: "applied"  },
						      { label: "Outstanding Patches",   y: severeVulnerabilityArray[1], name: "outstanding"  },
						   ]
					    }
				     ]
			      });
			      chart3.render();
			      $("#wLoad").remove();
			   }
		    }
	     }
		 
		 var compGroup = new XMLHttpRequest();
	     compGroup.open("GET", "proxies/ComputerGroupsDropDownList.php?user=" + curUser + "&pass=" + password + "&serv=" + server, true);
	     compGroup.send();
	     compGroup.onreadystatechange = function() {
		    if ((this.readyState === 4) && (this.status === 200)) {
		       xmlCompGrpList = this.responseText.toString();
			   var badQuery = xmlCompGrpList.substring((parseInt(xmlCompGrpList.search("Resource"))-1), (parseInt(xmlCompGrpList.search('Result'))-5));
			   xmlCompGrpList = xmlCompGrpList.replace(badQuery, '');
			   var parser = new DOMParser();
			   var xmlDoc = parser.parseFromString(xmlCompGrpList,"text/xml");
			   var rowCount = xmlDoc.getElementsByTagName("Answer").length;
			   var rowHTML = "";
			   for (var i = 0; i < rowCount; i++) {
			      rowHTML = "<li><a href='SevereVulnerabilityReport.php?cg=" + xmlDoc.getElementsByTagName("Answer")[i].childNodes[0].nodeValue + "'>" + xmlDoc.getElementsByTagName("Answer")[i].childNodes[0].nodeValue + "</a></li>";
			      $("#computerGroupList").append(rowHTML);
			   }
		    }
	     }
	
</script>

         <div class="span-15 append-1" style="margin-bottom:400px;">    
	        <div id="severeVulnerabilityChart" style=" height: 300; margin-bottom:20px;">
	           <div id="wLoad">
		          <br><img src="includes/loading.gif">
	           </div>
            </div>
         </div>

<table id="severeVulnerabilityTable">
                  <thead>
			         <tr>
			         <!-- <th>ID</th>  -->
                     <th>Computer</th>
                     <th>Users</th>
                     <th>Operating System</th>
                     <!-- <th>IP Addresses</th>  -->
                     <th>Last Report Time</th>
                     <th>Compliance Patches Applied</th>
                     <th>Compliance Patches Outstanding</th>
				     </tr>
			      </thead>
			      <tbody id="resultsHere">
			      </tbody>
               </table>

<?php require 'includes/footer.php'; ?>